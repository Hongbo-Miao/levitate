"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@grafana/e2e-selectors"),t=function(){return t=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},t.apply(this,arguments)};function n(e,t,n,o){return new(n||(n=Promise))((function(a,i){function r(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}c((o=o.apply(e,t||[])).next())}))}function o(e,t){var n,o,a,i,r={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,o&&(a=2&i[0]?o.return:i[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,i[1])).done)return a;switch(o=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return r.label++,{value:i[1],done:!1};case 5:r.label++,o=i[1],i=[0];continue;case 7:i=r.ops.pop(),r.trys.pop();continue;default:if(!(a=r.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){r=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){r.label=i[1];break}if(6===i[0]&&r.label<a[1]){r.label=a[1],a=i;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(i);break}a[2]&&r.ops.pop(),r.trys.pop();continue}i=t.call(e,r)}catch(e){i=[6,e],o=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function a(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,a,i=n.call(e),r=[];try{for(;(void 0===t||t-- >0)&&!(o=i.next()).done;)r.push(o.value)}catch(e){a={error:e}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(a)throw a.error}}return r}function i(e,t,n){if(n||2===arguments.length)for(var o,a=0,i=t.length;a<i;a++)!o&&a in t||(o||(o=Array.prototype.slice.call(t,0,a)),o[a]=t[a]);return e.concat(o||Array.prototype.slice.call(t))}var r={addedDashboards:[],addedDataSources:[],get lastAddedDashboard(){return s(this.addedDashboards,"title")},get lastAddedDashboardUid(){return s(this.addedDashboards,"uid")},get lastAddedDataSource(){return s(this.addedDataSources,"name")},get lastAddedDataSourceId(){return s(this.addedDataSources,"id")}},s=function(e,t){var n,o;return null!==(o=null===(n=e[e.length-1])||void 0===n?void 0:n[t])&&void 0!==o?o:""},c=function(){return G().wrap({getScenarioContext:function(){return t({},r)}},{log:!1}).invoke({log:!1},"getScenarioContext")},l=function(e){return'[aria-label="'+e+'"]'},u=function(e){return'[data-testid="'+e+'"]'},d=function(e){return void 0===e&&(e=""),new URL(e,G.env("BASE_URL")||G.config().baseUrl||"http://localhost:3000").href},p=function(e){var t=new URL(e).pathname.match(/\/d\/([^/]+)/);if(t)return t[1];throw new Error("Couldn't parse uid from "+e)},f=function(e,t){for(var n=function(e){return G().logToConsole("Retrieving Selector:",e)},o=Object.keys(t),a=function(a){var i=o[a],r=t[i];return"url"===i?(e.visit=function(e,t){var n="";return"string"==typeof r&&(n=d(r)),"function"==typeof r&&e&&(n=d(r(e))),G().logToConsole("Visiting",n),t?G().visit({url:n,qs:t}):G().visit(n)},"continue"):"string"==typeof r?(e[i]=function(e){n(r);var t=r.startsWith("data-testid")?u(r):l(r);return G().get(t,e)},"continue"):"function"==typeof r?(e[i]=function(e,t){if(0===arguments.length){var o=r(void 0);return n(o),G().get(o)}if(1===arguments.length){if("string"==typeof e){var a=(s=r(e)).startsWith("data-testid")?u(s):l(s);return n(a),G().get(a)}o=r(void 0);return n(o),G().get(o,e)}if(2===arguments.length&&"string"==typeof e){var i=e,s=r(i);o=i.startsWith("data-testid")?u(s):l(s);return n(o),G().get(o,t)}},"continue"):void("object"==typeof r&&(e[i]=f({},r)))},i=0;i<o.length;i++)a(i);return e},h=function(e){var n=e.selectors,o={};return f(o,n),t({},o)},g=function(e){var n=t({clickToOpen:!0,forceClickOption:!1},e),o=n.clickToOpen,a=n.container,i=n.forceClickOption,r=n.optionText;return a.within((function(){o&&G().get('[class$="-input-suffix"]').click()})),G.components.Select.option().filter((function(e,t){var n=t.textContent;return null!==n&&("string"==typeof r?n.includes(r):r.test(n))})).scrollIntoView().click({force:i})},b=function(e){return n=(t=e).from,o=t.to,a=t.zone,G.components.TimePicker.openButton().click(),a&&(G().contains("button","Change time settings").click(),G.components.TimeZonePicker.containerV2?g({clickToOpen:!0,container:G.components.TimeZonePicker.containerV2(),optionText:a}):g({clickToOpen:!0,container:G.components.TimeZonePicker.container(),optionText:a})),G.components.TimePicker.absoluteTimeRangeTitle().click(),G.components.TimePicker.fromField().clear().type(n),G.components.TimePicker.toField().clear().type(o),void G.components.TimePicker.applyTimeRange().click();var t,n,o,a},m="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),S=new Uint8Array(16);function v(){if(!m)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return m(S)}var A=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function D(e){return"string"==typeof e&&A.test(e)}for(var y=[],T=0;T<256;++T)y.push((T+256).toString(16).substr(1));function I(e,t,n){var o=(e=e||{}).random||(e.rng||v)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(var a=0;a<16;++a)t[n+a]=o[a];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(y[e[t+0]]+y[e[t+1]]+y[e[t+2]]+y[e[t+3]]+"-"+y[e[t+4]]+y[e[t+5]]+"-"+y[e[t+6]]+y[e[t+7]]+"-"+y[e[t+8]]+y[e[t+9]]+"-"+y[e[t+10]]+y[e[t+11]]+y[e[t+12]]+y[e[t+13]]+y[e[t+14]]+y[e[t+15]]).toLowerCase();if(!D(n))throw TypeError("Stringified UUID is invalid");return n}(o)}var k,w=function(e){return e.length>0&&G.pages.Dashboard.Settings.General.sectionItems("Annotations").click(),e.forEach((function(e,t){return function(e,t){t?G.pages.Dashboard.Settings.Annotations.List.addAnnotationCTAV2?G.pages.Dashboard.Settings.Annotations.List.addAnnotationCTAV2().click():G.pages.Dashboard.Settings.Annotations.List.addAnnotationCTA().click():cy.contains("New query").click();var n=e.dataSource,o=e.dataSourceForm,a=e.name;g({container:G.components.DataSourcePicker.container(),optionText:n}),G.pages.Dashboard.Settings.Annotations.Settings.name().clear().type(a),o&&o()}(e,0===t)}))},V=function(e){return e.length>0&&G.pages.Dashboard.Settings.General.sectionItems("Variables").click(),e.map((function(e,n){return function(e,n){var o=t({hide:"",type:"Query"},e);n?G.pages.Dashboard.Settings.Variables.List.addVariableCTAV2?G.pages.Dashboard.Settings.Variables.List.addVariableCTAV2().click():G.pages.Dashboard.Settings.Variables.List.addVariableCTA().click():G.pages.Dashboard.Settings.Variables.List.newButton().click();var a=o.constantValue,i=o.dataSource,r=o.label,s=o.name,c=o.query,l=o.regex,u=o.type;return"Query"!==u&&(G.pages.Dashboard.Settings.Variables.Edit.General.generalTypeSelect().should("be.visible").within((function(){G.components.Select.singleValue().should("have.text","Query").click()})),G.components.Select.option().should("be.visible").contains(u).click()),r&&G.pages.Dashboard.Settings.Variables.Edit.General.generalLabelInput().type(r),G.pages.Dashboard.Settings.Variables.Edit.General.generalNameInput().clear().type(s),!i||"Ad hoc filters"!==u&&"Datasource"!==u&&"Query"!==u||G.pages.Dashboard.Settings.Variables.Edit.QueryVariable.queryOptionsDataSourceSelect().should("be.visible").within((function(){G.components.Select.input().should("be.visible").type(i+"{enter}")})),a&&"Constant"===u&&G.pages.Dashboard.Settings.Variables.Edit.ConstantVariable.constantOptionsQueryInput().type(a),"Query"===u&&(c&&G.pages.Dashboard.Settings.Variables.Edit.QueryVariable.queryOptionsQueryInput().type(c),l&&G.pages.Dashboard.Settings.Variables.Edit.QueryVariable.queryOptionsRegExInput().type(l)),G().focused().blur(),G.pages.Dashboard.Settings.Variables.Edit.General.previewOfValuesOption().should("exist").within((function(e){"Constant"===u&&expect(e.text()).equals(a)})),G.pages.Dashboard.Settings.Variables.Edit.General.submitButton().click(),o}(e,0===n)}))},C=function(e){return c().then((function(n){var o=n.lastAddedDashboardUid,a=t({chartData:{method:"POST",route:"/api/ds/query"},dashboardUid:o,matchScreenshot:!1,saveDashboard:!0,screenshotName:"panel-visualization",visitDashboardAtStart:!0},e),i=a.chartData,r=a.dashboardUid,s=a.dataSourceName,c=a.isEdit,l=a.matchScreenshot,u=a.panelTitle,d=a.queriesForm,p=a.screenshotName,f=a.timeRange,h=a.visitDashboardAtStart,m=a.visualizationName;h&&G.flows.openDashboard({uid:r}),c?(G.components.Panels.Panel.title(u).click(),G.components.Panels.Panel.headerItems("Edit").click()):(G.components.PageToolbar.item("Add panel").click(),G.pages.AddDashboard.addNewPanel().click()),f&&b(f),G().intercept(i.method,i.route).as("chartData"),s&&g({container:G.components.DataSourcePicker.container(),optionText:s}),G().wait(2e3);var S=u&&!c;if(S||m?(S&&u&&G.components.PanelEditor.OptionsPane.fieldLabel("Panel options Title").type("{selectall}"+u),m&&(G.components.PluginVisualization.item(m).scrollIntoView().click(),G().wait(2e3))):P(),d&&(d(a),G().wait("@chartData"),G().wait(1e3)),G.components.RefreshPicker.runButton().should("be.visible").click(),G().wait("@chartData"),G().wait(500),l){G.components.Panels.Panel.containerByTitle(u).find(".panel-content").scrollIntoView().screenshot(p),G().compareScreenshots(p)}return G().wrap({config:a},{log:!1})}))},P=function(){return G.components.PanelEditor.toggleVizOptions().click()},E=function(e){G().request("DELETE",d("/api/dashboards/uid/"+e))},L=function(e,t){G.pages.Dashboard.visit(e),G.components.PageToolbar.item("Dashboard settings").click(),G.pages.Dashboard.Settings.General.deleteDashBoard().click(),G.pages.ConfirmModal.delete().click(),G.flows.assertSuccessNotification(),G.pages.Dashboards.visit(),G.components.Search.dashboardItems?G.components.Search.dashboardItems().each((function(e){return G().wrap(e).should("not.contain",t)})):G().get('[aria-label^="Dashboard search item "]').each((function(e){return G().wrap(e).should("not.contain",t)}))},O=function(e){G().request("DELETE",d("/api/datasources/name/"+e))},x=function(e){G.pages.DataSources.visit(),G.pages.DataSources.dataSources(e).click(),G.pages.DataSource.delete().click(),G.pages.ConfirmModal.delete().click(),G.pages.DataSources.visit(),G().get('[aria-label^="Data source list item "]').each((function(t){return G().wrap(t).should("not.contain",e)}))};!function(e){e.Edit="Edit",e.Inspect="Inspect"}(k||(k={}));var _,N=function(e,t){G().visit(d("/dashboard/import")),G.components.DashboardImportPage.textarea().should("be.visible").click().invoke("val",JSON.stringify(e)),G.components.DashboardImportPage.submit().should("be.visible").click(),G.components.ImportDashboardForm.name().should("be.visible").click().clear().type(e.title),G.components.ImportDashboardForm.submit().should("be.visible").click(),G().wait(t||6e3),G().url().should("contain","/d/").then((function(t){var n=p(t);G.getScenarioContext().then((function(t){var o=t.addedDashboards;G.setScenarioContext({addedDashboards:i(i([],a(o),!1),[{title:e.title,uid:n}],!1)})})),expect(e.uid).to.equal(n)})),e.panels.forEach((function(e){G.components.Panels.Panel.title(e.title).should("be.visible").click(),G.components.Panels.Panel.headerItems("Inspect").should("be.visible").click(),G.components.Tab.title("JSON").should("be.visible").click(),G.components.PanelInspector.Json.content().should("be.visible").contains("Panel JSON").click(),G.components.Select.option().should("be.visible").contains("Data").click(),G.components.CodeEditor.container().should("be.visible").contains('"state": "Done"'),G.components.Drawer.General.close().click()}))},R=Object.freeze({__proto__:null,VISUALIZATION_ALERT_LIST:"Alert list",VISUALIZATION_BAR_GAUGE:"Bar gauge",VISUALIZATION_CLOCK:"Clock",VISUALIZATION_DASHBOARD_LIST:"Dashboard list",VISUALIZATION_GAUGE:"Gauge",VISUALIZATION_GRAPH:"Graph",VISUALIZATION_HEAT_MAP:"Heatmap",VISUALIZATION_LOGS:"Logs",VISUALIZATION_NEWS:"News",VISUALIZATION_PIE_CHART:"Pie Chart",VISUALIZATION_PLUGIN_LIST:"Plugin list",VISUALIZATION_POLYSTAT:"Polystat",VISUALIZATION_STAT:"Stat",VISUALIZATION_TABLE:"Table",VISUALIZATION_TEXT:"Text",VISUALIZATION_WORLD_MAP:"Worldmap Panel",addDashboard:function(e){var n=t(t({annotations:[],title:"e2e-"+I(),variables:[]},e),{timeRange:t({from:"2020-01-01 00:00:00",to:"2020-01-01 06:00:00",zone:"Coordinated Universal Time"},null==e?void 0:e.timeRange)}),o=n.annotations,r=n.timeRange,s=n.title,c=n.variables;return G().logToConsole("Adding dashboard with title:",s),G.pages.AddDashboard.visit(),(o.length>0||c.length>0)&&(G.components.PageToolbar.item("Dashboard settings").click(),w(o),n.variables=V(c),G.components.BackButton.backArrow().should("be.visible").click({force:!0})),b(r),G.components.PageToolbar.item("Save dashboard").click(),G.pages.SaveDashboardAsModal.newName().clear().type(s),G.pages.SaveDashboardAsModal.save().click(),G.flows.assertSuccessNotification(),G().logToConsole("Added dashboard with title:",s),G().url().should("contain","/d/").then((function(e){var t=p(e);return G.getScenarioContext().then((function(e){var n=e.addedDashboards;G.setScenarioContext({addedDashboards:i(i([],a(n),!1),[{title:s,uid:t}],!1)})})),G().wrap({config:n,uid:t},{log:!1})}))},VARIABLE_HIDE_LABEL:"Label",VARIABLE_HIDE_NOTHING:"",VARIABLE_HIDE_VARIABLE:"Variable",VARIABLE_TYPE_AD_HOC_FILTERS:"Ad hoc filters",VARIABLE_TYPE_CONSTANT:"Constant",VARIABLE_TYPE_DATASOURCE:"Datasource",VARIABLE_TYPE_QUERY:"Query",addDataSource:function(e){var n=t({basicAuth:!1,basicAuthPassword:"",basicAuthUser:"",checkHealth:!1,expectedAlertMessage:"Data source is working",form:function(){},name:"e2e-"+I(),skipTlsVerify:!1,type:"TestData DB"},e),o=n.basicAuth,r=n.basicAuthPassword,s=n.basicAuthUser,c=n.expectedAlertMessage,l=n.form,u=n.name,d=n.skipTlsVerify,p=n.type,f=n.timeout;return G().logToConsole("Adding data source with name:",u),G.pages.AddDataSource.visit(),G.pages.AddDataSource.dataSourcePlugins(p).scrollIntoView().should("be.visible").click(),G.pages.DataSource.name().clear(),G.pages.DataSource.name().type(u),o&&(G().contains("label","Basic auth").scrollIntoView().click(),G().contains(".gf-form-group","Basic Auth Details").should("be.visible").scrollIntoView().within((function(){s&&G().get("[placeholder=user]").type(s),r&&G().get("[placeholder=Password]").type(r)}))),d&&G().contains("label","Skip TLS Verify").scrollIntoView().click(),l(),G.pages.DataSource.saveAndTest().click(),G.pages.DataSource.alert().should("exist").contains(c,{timeout:null!=f?f:G.config().defaultCommandTimeout}),G().logToConsole("Added data source with name:",u),G().url().then((function(){return G.getScenarioContext().then((function(e){var t=e.addedDataSources;G.setScenarioContext({addedDataSources:i(i([],a(t),!1),[{name:u}],!1)})})),G().wrap({config:n},{log:!1})}))},addPanel:function(e){return c().then((function(n){var o=n.lastAddedDataSource;return C(t(t({dataSourceName:o,panelTitle:"e2e-"+I()},e),{isEdit:!1}))}))},assertSuccessNotification:function(){G.components.Alert.alertV2?G.components.Alert.alertV2("success").should("exist"):G.components.Alert.alert("success").should("exist")},deleteDashboard:function(e){var t=e.quick,n=void 0!==t&&t,o=e.title,a=e.uid;G().logToConsole("Deleting dashboard with uid:",a),n?E(a):L(a,o),G().logToConsole("Deleted dashboard with uid:",a),G.getScenarioContext().then((function(e){var t=e.addedDashboards;G.setScenarioContext({addedDashboards:t.filter((function(e){return e.title!==o&&e.uid!==a}))})}))},deleteDataSource:function(e){var t=e.id,n=e.name,o=e.quick,a=void 0!==o&&o;G().logToConsole("Deleting data source with name:",n),a?O(n):x(n),G().logToConsole("Deleted data source with name:",n),G.getScenarioContext().then((function(e){var o=e.addedDataSources;G.setScenarioContext({addedDataSources:o.filter((function(e){return e.id!==t&&e.name!==n}))})}))},editPanel:function(e){return C(t(t({},e),{isEdit:!0}))},login:function(e,t){void 0===e&&(e="admin"),void 0===t&&(t="admin"),G().logToConsole("Logging in with username:",e),G.pages.Login.visit(),G.pages.Login.username().should("be.visible").type(e),G.pages.Login.password().type(t),G.pages.Login.submit().click(),"admin"===t&&G.pages.Login.skip().should("be.visible").click(),G().get(".login-page").should("not.exist"),G().logToConsole("Logged in with username:",e)},openDashboard:function(e){return c().then((function(n){var o=n.lastAddedDashboardUid,a=t({uid:o},e),i=a.timeRange,r=a.uid,s=a.queryParams;return G.pages.Dashboard.visit(r,s),i&&b(i),G().wrap({config:a},{log:!1})}))},get PanelMenuItems(){return k},openPanelMenuItem:function(e,t){void 0===t&&(t="Panel Title"),G.components.Panels.Panel.title(t).should("be.visible").click(),G.components.Panels.Panel.headerItems(e).should("be.visible").click()},revertAllChanges:function(){G.getScenarioContext().then((function(e){var n=e.addedDashboards,o=e.addedDataSources;n.forEach((function(e){return G.flows.deleteDashboard(t(t({},e),{quick:!0}))})),o.forEach((function(e){return G.flows.deleteDataSource(t(t({},e),{quick:!0}))}))}))},saveDashboard:function(){G.components.PageToolbar.item("Save dashboard").click(),G.pages.SaveDashboardModal.save().click(),G.flows.assertSuccessNotification()},selectOption:g,importDashboard:N,importDashboards:function(e,t){return n(void 0,void 0,void 0,(function(){return o(this,(function(n){return G().getJSONFilesFromDir(e).then((function(e){e.forEach((function(e){N(e,t||6e3)}))})),[2]}))}))}});!function(e){e.osx="darwin",e.windows="win32",e.linux="linux",e.aix="aix",e.freebsd="freebsd",e.openbsd="openbsd",e.sunos="sunos"}(_||(_={}));var U=Object.freeze({__proto__:null,undo:function(){return Cypress.platform===_.osx?"{cmd}z":"{ctrl}z"}}),B={env:function(e){return Cypress.env(e)},config:function(){return Cypress.config()},blobToBase64String:function(e){return Cypress.Blob.blobToBase64String(e)},imgSrcToBlob:function(e){return Cypress.Blob.imgSrcToBlob(e)},scenario:function(e){return n=(t=e).describeName,o=t.itName,a=t.scenario,i=t.skipScenario,r=void 0!==i&&i,s=t.addScenarioDataSource,c=void 0!==s&&s,l=t.addScenarioDashBoard,u=void 0!==l&&l,void describe(n,(function(){r?it.skip(o,(function(){return a()})):(before((function(){return G.flows.login(G.env("USERNAME"),G.env("PASSWORD"))})),beforeEach((function(){Cypress.Cookies.preserveOnce("grafana_session"),c&&G.flows.addDataSource(),u&&G.flows.addDashboard()})),afterEach((function(){return G.flows.revertAllChanges()})),after((function(){return G().clearCookies()})),it(o,(function(){return a()})),it("temporary",(function(){})))}));var t,n,o,a,i,r,s,c,l,u},pages:h({selectors:e.selectors.pages}),typings:U,components:h({selectors:e.selectors.components}),flows:R,getScenarioContext:c,setScenarioContext:function(e){return G().wrap({setScenarioContext:function(){Object.entries(e).forEach((function(e){var t=a(e,2),n=t[0],o=t[1];r[n]=o}))}},{log:!1}).invoke({log:!1},"setScenarioContext")},getSelectors:function(e){return h({selectors:e})}},G=Object.assign((function(){return cy}),B);exports.e2e=G;
//# sourceMappingURL=index.production.js.map
